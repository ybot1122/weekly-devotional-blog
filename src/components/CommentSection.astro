---
---

<div class="comment-section">
  <h3>Responses</h3>
  <div id="comment-list" data-article-id={Astro.props.articleId}>
    <p>loading...</p>
  </div>
  <!--
  <form id="comment-form" class="comment-form" data-article-id={Astro.props.articleId}>
    <div class="form-group">
      <label for="author" class="form-label">Name</label>
      <input
        type="text"
        id="author"
        name="author"
        required
        class="form-input"
      />
    </div>
    <div class="form-group">
      <label for="content" class="form-label">Comment</label>
      <textarea
        id="content"
        name="content"
        rows="4"
        required
        class="form-input"
      ></textarea>
    </div>
    <button
      type="submit"
      class="form-button"
    >
      Add Comment
    </button>
  </form>
-->
  <script>
    import { actions } from "astro:actions";
    const commentSection = document.getElementById('comment-list')!;
    const articleId = commentSection.dataset.articleId ?? '';
    const cid = 'data-astro-cid-'+ (Object.keys(commentSection.dataset).find(key => key.startsWith('astroCid'))?.substring(8).toLowerCase() ?? '');

    const {data: comments} = await actions.fetch_comments.fetchComments({article_id: articleId});

    commentSection.removeChild(commentSection.children[0]!);
    if (!comments || comments.length === 0) {
      const noComments = document.createElement('p')!;
      noComments.textContent = "No responses yet.";
      commentSection.appendChild(noComments);
    } else {
      comments.forEach(comment => {
        const commentDiv = document.createElement('div')!;
        const commentAuthor = document.createElement('span')!;
        const commentDate = document.createElement('span')!;
        const commentContent = document.createElement('div')!;

        commentAuthor.textContent = comment.author;
        commentDate.textContent = new Date(comment.created_at).toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
        commentContent.textContent = comment.content;

        commentDiv.appendChild(commentAuthor);
        commentDiv.appendChild(commentDate); 
        commentDiv.appendChild(commentContent);
        
        commentDiv.classList.add('comment');
        commentAuthor.classList.add('comment-author');
        commentDate.classList.add('comment-date');
        commentContent.classList.add('comment-content');

        commentDiv.setAttribute(cid, '');
        commentAuthor.setAttribute(cid, '');
        commentDate.setAttribute(cid, '');
        commentContent.setAttribute(cid, '');

        commentSection.appendChild(commentDiv);
      });
    }
  </script>
</div>

<style>
  .comment-section {
    margin-top: 2em;
    padding: 1em;
    background: #f9f9f9;
    border-radius: 8px;
  }
  .comment {
    border-bottom: 1px solid #e2e8f0;
    padding: 1em 0;
  }
  .comment:last-child {
    border-bottom: none;
  }
  .comment-author {
    font-weight: bold;
    color: #2b6cb0;
  }
  .comment-date {
    font-size: 0.9em;
    color: #718096;
    margin-left: 0.5em;
  }
  .comment-content {
    margin-top: 0.5em;
    color: #2d3748;
    white-space: pre-line;
  }
  .comment-form {
    margin-top: 2em;
  }
  .form-group {
    margin-bottom: 0.5em;
  }
  .form-label {
    display: block;
    font-weight: bold;
  }
  .form-input {
    width: 100%;
    padding: 0.5em;
    border: 1px solid #cbd5e0;
    border-radius: 4px;
  }
  .form-button {
    background: #2b6cb0;
    color: white;
    padding: 0.5em 1.5em;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
</style>
